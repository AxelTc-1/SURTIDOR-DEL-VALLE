<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ubicaci√≥n con HERE Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: Arial; background: #f0f0f0; }
    #map { height: 300px; width: 100%; position: relative; }
    .center-marker {
      position: absolute;
      top: 50%; left: 50%;
      width: 32px; height: 32px;
      margin-top: -32px; margin-left: -16px;
      background: url('https://cdn-icons-png.flaticon.com/512/684/684908.png') no-repeat center center;
      background-size: 100%;
      z-index: 10;
      pointer-events: none;
    }
    .container {
      max-width: 480px; margin: 10px auto;
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%; padding: 12px; margin-bottom: 10px;
      border-radius: 6px; border: 1px solid #ccc; font-size: 16px;
    }
    button {
      background-color: #007bff; color: white; border: none;
      font-weight: bold; cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    #status { font-size: 14px; color: gray; margin: 10px 0; }
    ul#suggestions {
      list-style: none; padding: 0; margin-top: -10px;
      background: white; border: 1px solid #ccc;
      max-height: 150px; overflow-y: auto; position: absolute;
      width: 100%; z-index: 999;
    }
    ul#suggestions li {
      padding: 10px; cursor: pointer;
    }
    ul#suggestions li:hover {
      background: #f0f0f0;
    }
    #editarBtn {
      background-color: #6c757d;
    }
    .tipo-selector {
      display: flex; gap: 10px; margin: 10px 0;
    }
    .tipo-selector button {
      flex: 1;
      background: #e9ecef; color: #000;
      border: 1px solid #ccc;
    }
    .tipo-selector button.selected {
      background: #007bff; color: #fff; border-color: #0056b3;
    }
  </style>

  <!-- HERE Maps SDK -->
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
</head>
<body>

<div id="map">
  <div class="center-marker"></div>
</div>

<div class="container">
  <h3>Actualizar Direcci√≥n</h3>

  <div style="position:relative;">
    <input id="searchInput" type="text" placeholder="Buscar direcci√≥n..." autocomplete="off">
    <ul id="suggestions"></ul>
  </div>

  <button onclick="usarUbicacion()">üìç Usar mi ubicaci√≥n actual</button>
  <div id="status">Mueve el mapa o busca una direcci√≥n</div>

  <div class="tipo-selector">
    <button id="btnCasa" onclick="seleccionarTipo('Casa')">üè† Casa</button>
    <button id="btnTrabajo" onclick="seleccionarTipo('Trabajo')">üíº Trabajo</button>
    <button id="btnOtro" onclick="seleccionarTipo('Otro')">üìç Punto</button>
  </div>

  <form id="direccionForm">
    <label for="direccion">Direcci√≥n</label>
    <input type="text" id="direccion" readonly required>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
    <input type="hidden" id="tipo">
    <button type="submit">Guardar Direcci√≥n</button>
  </form>

  <button id="editarBtn" onclick="permitirEditar()" style="display:none;">‚úèÔ∏è Editar direcci√≥n</button>
</div>

<script>
  const apiKey = 'CGKVKtMsXUqQO2Mt8Fw6N2Zxjiq6eTeFF3uSfaUum04';
  const platform = new H.service.Platform({ apikey: apiKey });
  const defaultLayers = platform.createDefaultLayers();
  let direccionFijada = false;

  const map = new H.Map(document.getElementById('map'), defaultLayers.vector.normal.map, {
    zoom: 15,
    center: { lat: 17.0732, lng: -96.7266 },
    pixelRatio: window.devicePixelRatio || 1
  });

  window.addEventListener('resize', () => map.getViewPort().resize());

  const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
  const ui = H.ui.UI.createDefault(map, defaultLayers);

  behavior.disable(H.mapevents.Behavior.WHEELZOOM);
  map.getElement().addEventListener('wheel', e => {
    if (direccionFijada) return;
    e.preventDefault();
    const zoom = map.getZoom();
    const delta = Math.sign(e.deltaY) > 0 ? -1 : 1;
    map.setZoom(zoom + delta);
  });

  map.addEventListener('mapviewchangeend', () => {
    if (!direccionFijada) actualizarDireccionDesdeCentro();
  });

  function actualizarDireccionDesdeCentro() {
    if (direccionFijada) return;
    const center = map.getCenter();
    fetch(`https://revgeocode.search.hereapi.com/v1/revgeocode?at=${center.lat},${center.lng}&lang=es&apikey=${apiKey}`)
      .then(res => res.json())
      .then(data => {
        const direccion = data.items[0]?.address?.label || '';
        document.getElementById('lat').value = center.lat;
        document.getElementById('lng').value = center.lng;
        document.getElementById('direccion').value = direccion;
        document.getElementById('status').textContent = 'Direcci√≥n actualizada autom√°ticamente.';
      });
  }

  function usarUbicacion() {
    if (direccionFijada) return;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const nueva = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        map.setCenter(nueva);
        actualizarDireccionDesdeCentro();
      });
    }
  }

  document.getElementById('searchInput').addEventListener('input', e => {
    if (direccionFijada) return;
    const query = e.target.value;
    if (query.length < 3) return;

    fetch(`https://autocomplete.search.hereapi.com/v1/autocomplete?q=${encodeURIComponent(query)}&at=17.0732,-96.7266&lang=es&limit=5&apikey=${apiKey}`)
      .then(res => res.json())
      .then(data => {
        const suggestions = data.items || [];
        const ul = document.getElementById('suggestions');
        ul.innerHTML = '';
        suggestions.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.address.label;
          li.onclick = () => {
            document.getElementById('searchInput').value = item.address.label;
            ul.innerHTML = '';
            fetch(`https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(item.address.label)}&lang=es&apikey=${apiKey}`)
              .then(res => res.json())
              .then(geo => {
                const pos = geo.items[0]?.position;
                if (pos) {
                  map.setCenter(pos);
                  actualizarDireccionDesdeCentro();
                } else {
                  alert('No se pudo ubicar la direcci√≥n con precisi√≥n.');
                }
              });
          };
          ul.appendChild(li);
        });
      });
  });

  function seleccionarTipo(tipo) {
    document.getElementById('tipo').value = tipo;
    ['btnCasa', 'btnTrabajo', 'btnOtro'].forEach(id => {
      document.getElementById(id).classList.remove('selected');
    });
    if (tipo === 'Casa') document.getElementById('btnCasa').classList.add('selected');
    if (tipo === 'Trabajo') document.getElementById('btnTrabajo').classList.add('selected');
    if (tipo === 'Otro') document.getElementById('btnOtro').classList.add('selected');
  }

  document.getElementById('direccionForm').addEventListener('submit', e => {
    e.preventDefault();
    const tipo = document.getElementById('tipo').value;
    if (!tipo) {
      alert('Selecciona un tipo de direcci√≥n.');
      return;
    }

    direccionFijada = true;
    document.getElementById('status').textContent = '‚úÖ Direcci√≥n fijada correctamente.';
    document.getElementById('editarBtn').style.display = 'block';
    alert('Direcci√≥n guardada correctamente.');

    console.log({
      tipo: tipo,
      direccion: document.getElementById('direccion').value,
      lat: document.getElementById('lat').value,
      lng: document.getElementById('lng').value
    });
  });

  function permitirEditar() {
    direccionFijada = false;
    document.getElementById('status').textContent = 'Puedes mover el mapa o buscar una nueva direcci√≥n.';
    document.getElementById('editarBtn').style.display = 'none';
  }

  actualizarDireccionDesdeCentro();
</script>

</body>
</html>

