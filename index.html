<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema Imprenta Profesional</title>

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
  <!-- Leaflet y Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

  <style>
    :root {
      --color-primary:    #003366;
      --color-accent:     #E68A00;
      --bg-light:         #f8f9fd;
      --radius:           8px;
      --transition-fast:  0.2s ease;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #f5f5f5 80%, #e3ecff 100%);
      color: #333; line-height: 1.4;
    }
    .container {
      max-width:1200px; margin:40px auto;
      background:#fff; border-radius:var(--radius);
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
      padding:36px;
    }
    .tabs { display:flex; border-bottom:2px solid #e3ecff; margin-bottom:34px; }
    .tab-btn {
      flex:1; padding:15px; font-size:18px; font-weight:600;
      background:none; border:none; color:var(--color-primary);
      cursor:pointer; border-bottom:4px solid transparent;
      transition: color var(--transition-fast), border-color var(--transition-fast);
    }
    .tab-btn.active {
      color:var(--color-accent);
      border-bottom-color:var(--color-accent);
      background:#f9f9fa;
    }
    .tab-content { display:none; animation:fadeIn 0.6s ease-out; }
    .tab-content.active { display:block; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(25px); }
      to   { opacity:1; transform:none; }
    }
    form {
      margin-bottom:26px; background:var(--bg-light);
      border-radius:var(--radius); padding:18px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      display:flex; flex-direction:column; gap:10px;
    }
    label { font-weight:bold; font-size:15px; }
    input, select, textarea {
      padding:8px; border:1.2px solid #c3c9e6;
      border-radius:var(--radius); font-size:15px;
      transition:border-color var(--transition-fast), background var(--transition-fast);
    }
    input:focus, select:focus, textarea:focus {
      outline:none; border-color:var(--color-primary); background:#e5f1ff;
    }
    .btn, .btn-secondary {
      padding:10px 18px; border:none; border-radius:var(--radius);
      font-weight:bold; font-size:16px; cursor:pointer;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
      transition:transform var(--transition-fast), background var(--transition-fast);
    }
    .btn { background:var(--color-accent); color:#fff; }
    .btn:hover { background:var(--color-primary); transform:translateY(-2px) scale(1.05); }
    .btn-secondary { background:#6c757d; color:#fff; }
    .btn-secondary:hover { background:#495057; }
    .hidden { display:none!important; }
    table {
      width:100%; border-collapse:collapse;
      margin-bottom:26px; background:#fdfdff;
      border-radius:var(--radius); overflow:hidden;
      box-shadow:0 2px 12px rgba(0,0,0,0.05);
    }
    th, td { border:1px solid #f0f0f0; padding:11px 14px; text-align:left; font-size:14px; }
    th { background:var(--color-accent); color:#fff; font-size:15px; }
    tr:nth-child(even) td { background:#f6f7fc; }
    tr:hover td { background:#e8f1ff; }
    .icon-btn { background:none; border:none; font-size:21px; cursor:pointer; color:var(--color-primary); }
    .icon-btn:hover { color:var(--color-accent); }
    .autocomplete { position:relative; }
    .autocomplete-items {
      position:absolute; top:100%; left:0; right:0;
      background:#fff; border:1px solid #c3c9e6; max-height:180px; overflow-y:auto; z-index:99;
    }
    .autocomplete-item { padding:8px 10px; cursor:pointer; }
    .autocomplete-item:hover { background-color:#e8f1ff; }
    #mapClientes, #mapRuta { height:350px; border-radius:var(--radius); margin-top:20px; }
    .report-summary {
      display:inline-block; width:calc(33.333% - 1rem); margin-right:1rem; padding:12px;
      background:#e7f5ea; border-radius:var(--radius); font-size:17px;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
    }
    @media(max-width:768px){
      .tabs{flex-direction:column;}
      form,table{width:100%;font-size:0.9rem;}
      #mapClientes,#mapRuta{height:250px;}
      .report-summary{width:100%;margin-bottom:1rem;}
    }
    .modal-backdrop {
      display:flex; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;
    }
    .modal {
      background:#fff; border-radius:var(--radius); padding:20px;
      box-shadow:0 2px 10px rgba(0,0,0,0.3); max-width:90%; width:320px;
    }
    .pedido-filters{display:flex;gap:8px;margin-bottom:16px;}
    .pedido-filters .btn-filter{
      padding:6px 12px; border:1px solid var(--color-accent);
      background:var(--bg-light); border-radius:var(--radius);
      cursor:pointer; font-weight:600;
      transition:background var(--transition-fast),color var(--transition-fast);
    }
    .pedido-filters .btn-filter.active{
      background:var(--color-accent); color:#fff;
    }
    .pedido-filters .btn-filter:hover{
      background:var(--color-accent); color:#fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('productos')">Productos</button>
      <button class="tab-btn" onclick="showTab('clientes')">Clientes</button>
      <button class="tab-btn" onclick="showTab('pedidos')">Pedidos</button>
      <button class="tab-btn" onclick="showTab('reportes')">Reportes</button>
    </div>

    <!-- Productos -->
    <section id="productos" class="tab-content active">
      <h2>Productos</h2>
      <form id="formProducto" autocomplete="off" novalidate>
        <input type="hidden" id="prodIdEditar">
        <label for="prodDescripcion">Nombre de producto:</label>
        <input type="text" id="prodDescripcion" required>
        <label for="prodBordado">¬øEs bordado?</label>
        <select id="prodBordado" onchange="toggleBordadoExtra()">
          <option value="No">No</option><option value="S√≠">S√≠</option>
        </select>
        <div id="divBordadoExtra" class="hidden">
          <label for="prodIncluyeBordadoExtra">¬øIncluye bordado extra?</label>
          <select id="prodIncluyeBordadoExtra"><option>No</option><option>S√≠</option></select>
          <label for="prodPrecioBordado">Precio bordado extra:</label>
          <input type="number" id="prodPrecioBordado" min="0" step="0.01" value="0">
        </div>
        <label for="prodIncluyeDiseno">¬øIncluye dise√±o?</label>
        <select id="prodIncluyeDiseno" onchange="toggleDisenoExtra()">
          <option value="No">No</option><option value="S√≠">S√≠</option>
        </select>
        <div id="divDisenoExtra" class="hidden">
          <label>Opciones de dise√±o:</label>
          <div id="disenoOptionsContainer"></div>
          <button type="button" id="btnAgregarOpcionDiseno" class="btn-secondary">Agregar opci√≥n</button>
        </div>
        <label for="prodDiasHabiles">D√≠as h√°biles:</label>
        <input type="number" id="prodDiasHabiles" min="1" value="1" required>
        <label for="prodRastreable">Stock rastreable:</label>
        <select id="prodRastreable" onchange="toggleStockInput()">
          <option value="S√≠">S√≠</option><option value="No">No</option>
        </select>
        <div id="divProdStock">
          <label for="prodStock">Stock:</label>
          <input type="number" id="prodStock" min="0" value="0" required>
        </div>
        <label for="prodPrecio">Precio base:</label>
        <input type="number" id="prodPrecio" step="0.01" required>
        <button class="btn" type="submit">Guardar Producto</button>
        <button class="btn-secondary hidden" id="btnCancelarEdicionProducto" type="button">Cancelar</button>
      </form>
      <table id="tablaProductos">
        <thead>
          <tr>
            <th>Nombre</th><th>Bordado</th><th>Dise√±o</th><th>Opciones</th>
            <th>D√≠as</th><th>Rastreable</th><th>Stock</th><th>Precio</th>
            <th>Editar</th><th>Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Clientes -->
    <section id="clientes" class="tab-content">
      <h2>Clientes</h2>
      <form id="formCliente" autocomplete="off" novalidate>
        <input type="hidden" id="cliIdEditar">
        <label for="cliNombre">Nombre:</label>
        <input type="text" id="cliNombre" required>
        <label for="cliTelefono">Tel√©fono:</label>
        <input type="tel" id="cliTelefono" pattern="[0-9()+\-\s]+" required>
        <label for="cliEmpresa">Empresa:</label>
        <input type="text" id="cliEmpresa">
        <label for="cliEmail">Email:</label>
        <input type="email" id="cliEmail">
        <label for="cliUbicacion">Ubicaci√≥n (lat,long):</label>
        <input type="text" id="cliUbicacion" placeholder="19.1234,-96.1234" required>
        <button class="btn" type="submit">Guardar Cliente</button>
        <button class="btn-secondary hidden" id="btnCancelarEdicionCliente" type="button">Cancelar</button>
      </form>
      <table id="tablaClientes">
        <thead>
          <tr>
            <th>Nombre</th><th>Tel√©fono</th><th>Empresa</th>
            <th>Email</th><th>Ubicaci√≥n</th><th>Editar</th><th>Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="mapClientes"></div>
    </section>

    <!-- Pedidos -->
    <section id="pedidos" class="tab-content">
      <h2>Pedidos</h2>
      <form id="formPedido" autocomplete="off" novalidate>
        <input type="hidden" id="pedidoIdEditar">
        <div class="autocomplete">
          <label for="pedidoClienteBuscador">Buscar cliente:</label>
          <input type="text" id="pedidoClienteBuscador" autocomplete="off">
          <div id="autocompleteCliente" class="autocomplete-items"></div>
        </div>
        <div class="autocomplete">
          <label for="pedidoProductoBuscador">Buscar producto:</label>
          <input type="text" id="pedidoProductoBuscador" autocomplete="off">
          <div id="listaProductosMatches" class="autocomplete-items"></div>
        </div>
        <label for="pedidoCantidad">Cantidad:</label>
        <input type="number" id="pedidoCantidad" min="1" required>
        <div id="divPedidoBordados" class="hidden">
          <label for="pedidoBordados">Bordados extra:</label>
          <input type="number" id="pedidoBordados" min="0" value="0">
        </div>
        <div id="divPedidoDisenoIncluido" class="hidden">
          <label for="pedidoIncluyeDiseno">¬øIncluye dise√±o?</label>
          <select id="pedidoIncluyeDiseno" onchange="mostrarOpcionesDisenoPedido()">
            <option value="No">No</option><option value="S√≠">S√≠</option>
          </select>
        </div>
        <div id="divPedidoOpcionesDiseno" class="hidden">
          <label>Opciones de dise√±o:</label>
          <div id="pedidoOpcionesDisenoContainer"></div>
          <label for="pedidoCaracteristicasDiseno">Detalles dise√±o:</label>
          <textarea id="pedidoCaracteristicasDiseno" rows="3"></textarea>
        </div>
        <label for="pedidoNotas">Notas:</label>
        <input type="text" id="pedidoNotas">
        <button class="btn" type="submit">Crear Pedido</button>
      </form>

      <!-- Filtros de estado -->
      <div class="pedido-filters">
        <button class="btn-filter active"    data-filter="todos">Todos</button>
        <button class="btn-filter"           data-filter="produccion">En producci√≥n</button>
        <button class="btn-filter"           data-filter="listos">Listos para entrega</button>
        <button class="btn-filter"           data-filter="entregados">Entregados</button>
      </div>

      <table id="tablaPedidos">
        <thead>
          <tr>
            <th>Cliente</th><th>Producto</th><th>Cant</th><th>Total</th>
            <th>Estado</th><th>Entrega</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="mapRuta"></div>
    </section>

    <!-- Reportes -->
    <section id="reportes" class="tab-content">
      <h2>Reportes</h2>
      <div class="report-summary" id="sumProduccion"></div>
      <div class="report-summary" id="sumListos"></div>
      <div class="report-summary" id="sumEntregados"></div>
    </section>
  </div>

  <!-- Librer√≠as externas -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAr8-ybVqcaeubCs-bApA_FAKnDgj9S7vM",
      authDomain: "maquilero-8344b.firebaseapp.com",
      projectId: "maquilero-8344b",
      storageBucket: "maquilero-8344b.firebasestorage.app",
      messagingSenderId: "323366654858",
      appId: "1:323366654858:web:5527744db419863da6ee73",
      measurementId: "G-H26F2MCQWD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Datos en memoria
    let productos = [], clientes = [], pedidos = [], pendingListos = [];
    let mapClientes, mapRuta, markersClientes, routingControl;
    let mapClientesInit=false, mapRutaInit=false;
    let currentFilter='todos';

    // Helpers
    function debounce(fn, delay=300){
      let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),delay); };
    }
    function resetForm(id){
      const f=document.getElementById(id);
      f.reset(); f.querySelector('input[type=hidden]').value='';
      ['#divPedidoBordados','#divPedidoDisenoIncluido','#divPedidoOpcionesDiseno']
        .forEach(s=>document.querySelector(s)?.classList.add('hidden'));
    }

    // Pesta√±as
    async function showTab(id){
      document.querySelectorAll('.tab-content').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="showTab('${id}')"]`).classList.add('active');
      if(id==='clientes') initMapClientes();
      if(id==='pedidos') calcularRuta();
      if(id==='reportes') actualizarReportes();
    }

    // Inicializaci√≥n y escuchas en tiempo real
    window.addEventListener('load', ()=>{
      bindClientSearch(); bindProductSearch(); setupPedidoFilters();

      db.collection('productos').onSnapshot(snap=>{
        productos=snap.docs.map(d=>({id:d.id,...d.data()}));
        listarProductos(); renderPedidos();
      });
      db.collection('clientes').onSnapshot(snap=>{
        clientes=snap.docs.map(d=>({id:d.id,...d.data()}));
        listarClientes(); renderPedidos();
      });
      db.collection('pedidos').onSnapshot(snap=>{
        pedidos=snap.docs.map(d=>({id:d.id,...d.data()}));
        renderPedidos(); actualizarReportes();
      });
    });

    // Productos
    function listarProductos(){
      const tb=document.querySelector('#tablaProductos tbody'); tb.innerHTML='';
      productos.forEach(p=>{
        const ops=(p.opcionesDiseno||[]).map(o=>`${o.nombre}($${o.precio.toFixed(2)})`).join(', ');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${p.descripcion}</td>
          <td>${p.esBordado||'No'}</td>
          <td>${p.incluyeDiseno||'No'}</td>
          <td>${ops}</td>
          <td>${p.diasHabiles}</td>
          <td>${p.rastreable}</td>
          <td>${p.stock}</td>
          <td>$${p.precio.toFixed(2)}</td>
          <td><button class="icon-btn" onclick="editarProducto('${p.id}')"><i class="ri-edit-line"></i></button></td>
          <td><button class="icon-btn" onclick="eliminarProducto('${p.id}')"><i class="ri-delete-bin-line"></i></button></td>`;
        tb.appendChild(tr);
      });
    }
    document.getElementById('formProducto').addEventListener('submit',async e=>{
      e.preventDefault();
      const id=document.getElementById('prodIdEditar').value;
      const desc=document.getElementById('prodDescripcion').value.trim();
      const esBor=document.getElementById('prodBordado').value;
      const incBor=document.getElementById('prodIncluyeBordadoExtra').value;
      const preBor=parseFloat(document.getElementById('prodPrecioBordado').value)||0;
      const incDes=document.getElementById('prodIncluyeDiseno').value;
      const dias=parseInt(document.getElementById('prodDiasHabiles').value)||1;
      const rast=document.getElementById('prodRastreable').value;
      const stk=rast==='S√≠'?parseInt(document.getElementById('prodStock').value)||0:0;
      const pre=parseFloat(document.getElementById('prodPrecio').value);
      if(!desc||isNaN(pre)){ alert('Completa campos'); return; }
      let ops=[];
      if(incDes==='S√≠'){
        ops=Array.from(document.querySelectorAll('#disenoOptionsContainer > div'))
          .map(r=>({ nombre:r.querySelector('.optName').value.trim(),
                     precio:parseFloat(r.querySelector('.optPrice').value)||0 }))
          .filter(o=>o.nombre);
      }
      const data={ descripcion:desc, esBordado:esBor,
                   incluyeBordadoExtra:incBor, precioBordadoExtra:preBor,
                   incluyeDiseno:incDes, opcionesDiseno:ops,
                   diasHabiles:dias, rastreable:rast,
                   stock:stk, precio:pre };
      if(id) await db.collection('productos').doc(id).update(data);
      else   await db.collection('productos').add(data);
      resetForm('formProducto'); document.getElementById('btnCancelarEdicionProducto').classList.add('hidden');
    });
    window.editarProducto=id=>{
      const p=productos.find(x=>x.id===id); if(!p)return;
      document.getElementById('prodIdEditar').value=id;
      document.getElementById('prodDescripcion').value=p.descripcion;
      document.getElementById('prodBordado').value=p.esBordado; toggleBordadoExtra();
      document.getElementById('prodIncluyeBordadoExtra').value=p.incluyeBordadoExtra;
      document.getElementById('prodPrecioBordado').value=p.precioBordadoExtra;
      document.getElementById('prodIncluyeDiseno').value=p.incluyeDiseno; toggleDisenoExtra();
      const c=document.getElementById('disenoOptionsContainer'); c.innerHTML='';
      (p.opcionesDiseno||[]).forEach(o=>{
        document.getElementById('btnAgregarOpcionDiseno').click();
        const last=c.lastElementChild;
        last.querySelector('.optName').value=o.nombre;
        last.querySelector('.optPrice').value=o.precio;
      });
      document.getElementById('prodDiasHabiles').value=p.diasHabiles;
      document.getElementById('prodRastreable').value=p.rastreable; toggleStockInput();
      document.getElementById('prodStock').value=p.stock;
      document.getElementById('prodPrecio').value=p.precio;
      document.getElementById('btnCancelarEdicionProducto').classList.remove('hidden');
    };
    window.eliminarProducto=async id=>{
      if(!confirm('¬øEliminar producto?'))return;
      await db.collection('productos').doc(id).delete();
    };
    document.getElementById('btnAgregarOpcionDiseno').addEventListener('click',()=>{
      const r=document.createElement('div');
      r.style.display='flex'; r.style.gap='8px'; r.style.marginBottom='8px';
      r.innerHTML=`
        <input type="text" class="optName" placeholder="Nombre opci√≥n" required>
        <input type="number" class="optPrice" placeholder="Precio" min="0" step="0.01" required>
        <button type="button" class="icon-btn removeOpt"><i class="ri-close-circle-line"></i></button>`;
      r.querySelector('.removeOpt').onclick=()=>r.remove();
      document.getElementById('disenoOptionsContainer').appendChild(r);
    });
    function toggleBordadoExtra(){
      document.getElementById('divBordadoExtra').classList.toggle(
        'hidden', document.getElementById('prodBordado').value!=='S√≠'
      );
    }
    function toggleDisenoExtra(){
      document.getElementById('divDisenoExtra').classList.toggle(
        'hidden', document.getElementById('prodIncluyeDiseno').value!=='S√≠'
      );
    }
    function toggleStockInput(){
      document.getElementById('divProdStock').classList.toggle(
        'hidden', document.getElementById('prodRastreable').value!=='S√≠'
      );
    }

    // Clientes
    function listarClientes(){
      const tb=document.querySelector('#tablaClientes tbody'); tb.innerHTML='';
      clientes.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${c.nombre}</td>
          <td>${c.telefono}</td>
          <td>${c.empresa||''}</td>
          <td>${c.email||''}</td>
          <td>${c.latitud},${c.longitud}</td>
          <td><button class="icon-btn" onclick="editarCliente('${c.id}')"><i class="ri-edit-line"></i></button></td>
          <td><button class="icon-btn" onclick="eliminarCliente('${c.id}')"><i class="ri-delete-bin-line"></i></button></td>`;
        tb.appendChild(tr);
      });
      if(mapClientesInit) updateClientMarkers();
    }
    document.getElementById('formCliente').addEventListener('submit',async e=>{
      e.preventDefault();
      const id=document.getElementById('cliIdEditar').value;
      const nombre=document.getElementById('cliNombre').value.trim();
      const telefono=document.getElementById('cliTelefono').value.trim();
      const empresa=document.getElementById('cliEmpresa').value.trim();
      const email=document.getElementById('cliEmail').value.trim();
      const ubic=document.getElementById('cliUbicacion').value.trim();
      const partes=ubic.split(',').map(s=>s.trim());
      if(!nombre||!telefono||partes.length!==2||isNaN(parseFloat(partes[0]))||isNaN(parseFloat(partes[1]))){
        alert('Datos cliente inv√°lidos'); return;
      }
      const data={ nombre, telefono, empresa, email,
                   latitud:parseFloat(partes[0]), longitud:parseFloat(partes[1]) };
      if(id) await db.collection('clientes').doc(id).update(data);
      else   await db.collection('clientes').add(data);
      resetForm('formCliente'); document.getElementById('btnCancelarEdicionCliente').classList.add('hidden');
    });
    window.editarCliente=id=>{
      const c=clientes.find(x=>x.id===id); if(!c)return;
      document.getElementById('cliIdEditar').value=id;
      document.getElementById('cliNombre').value=c.nombre;
      document.getElementById('cliTelefono').value=c.telefono;
      document.getElementById('cliEmpresa').value=c.empresa;
      document.getElementById('cliEmail').value=c.email;
      document.getElementById('cliUbicacion').value=`${c.latitud},${c.longitud}`;
      document.getElementById('btnCancelarEdicionCliente').classList.remove('hidden');
    };
    window.eliminarCliente=async id=>{
      if(!confirm('¬øEliminar cliente?'))return;
      await db.collection('clientes').doc(id).delete();
    };
    document.getElementById('btnCancelarEdicionCliente').addEventListener('click',()=>{
      resetForm('formCliente');
      document.getElementById('btnCancelarEdicionCliente').classList.add('hidden');
    });

    // Autocomplete
    function bindClientSearch(){
      const inp=document.getElementById('pedidoClienteBuscador'), list=document.getElementById('autocompleteCliente');
      inp.addEventListener('input',debounce(()=>{
        const v=inp.value.trim().toLowerCase(); list.innerHTML='';
        if(!v)return;
        clientes.forEach(c=>{
          if((c.nombre+(c.empresa?` (${c.empresa})`:``)).toLowerCase().includes(v)){
            const d=document.createElement('div');
            d.className='autocomplete-item';
            d.innerHTML=`<strong>${c.nombre}</strong>${c.empresa?` (${c.empresa})`:``}`;
            d.onclick=()=>{
              inp.value=`${c.nombre}${c.empresa?` (${c.empresa})`:``}`; inp.dataset.id=c.id; list.innerHTML='';
              updatePedidoExtras();
            };
            list.appendChild(d);
          }
        });
      },250));
      document.addEventListener('click',e=>{ if(e.target!==inp) list.innerHTML=''; });
    }
    function bindProductSearch(){
      const inp=document.getElementById('pedidoProductoBuscador'), list=document.getElementById('listaProductosMatches');
      inp.addEventListener('input',debounce(()=>{
        const v=inp.value.trim().toLowerCase(); list.innerHTML='';
        if(!v)return;
        productos.forEach(p=>{
          if(p.descripcion.toLowerCase().includes(v)){
            const d=document.createElement('div');
            d.className='autocomplete-item';
            d.innerHTML=`<strong>${p.descripcion}</strong>`;
            d.onclick=()=>{
              inp.value=p.descripcion; inp.dataset.id=p.id; list.innerHTML='';
              updatePedidoExtras();
            };
            list.appendChild(d);
          }
        });
      },250));
      document.addEventListener('click',e=>{ if(e.target!==inp) list.innerHTML=''; });
    }
    function updatePedidoExtras(){
      const pid=document.getElementById('pedidoProductoBuscador').dataset.id||'';
      const prod=productos.find(p=>p.id===pid)||{};
      document.getElementById('divPedidoBordados').classList.toggle('hidden',!(prod.esBordado==='S√≠'&&prod.incluyeBordadoExtra==='S√≠'));
      const show=prod.incluyeDiseno==='S√≠';
      document.getElementById('divPedidoDisenoIncluido').classList.toggle('hidden',!show);
      if(!show){
        document.getElementById('pedidoIncluyeDiseno').value='No';
        document.getElementById('divPedidoOpcionesDiseno').classList.add('hidden');
      }
    }
    function mostrarOpcionesDisenoPedido(){
      const pid=document.getElementById('pedidoProductoBuscador').dataset.id||'';
      const prod=productos.find(p=>p.id===pid)||{};
      const cont=document.getElementById('pedidoOpcionesDisenoContainer'); cont.innerHTML='';
      if(document.getElementById('pedidoIncluyeDiseno').value==='S√≠'){
        prod.opcionesDiseno.forEach(o=>{
          const d=document.createElement('div');
          d.innerHTML=`<label><input type="checkbox" class="pedidoOpcionCheckbox" value="${o.nombre}"> ${o.nombre} ($${o.precio.toFixed(2)})</label>`;
          cont.appendChild(d);
        });
        document.getElementById('divPedidoOpcionesDiseno').classList.remove('hidden');
      }
    }

    // Pedidos
    document.getElementById('formPedido').addEventListener('submit',async e=>{
      e.preventDefault();
      const cliId=document.getElementById('pedidoClienteBuscador').dataset.id||'';
      const prodId=document.getElementById('pedidoProductoBuscador').dataset.id||'';
      const cant=parseInt(document.getElementById('pedidoCantidad').value);
      if(!cliId||!prodId||isNaN(cant)||cant<1){ alert('Datos inv√°lidos'); return; }
      const prod=productos.find(p=>p.id===prodId)||{};
      const bord=parseInt(document.getElementById('pedidoBordados').value)||0;
      const opts=[...document.querySelectorAll('.pedidoOpcionCheckbox:checked')].map(cb=>cb.value);
      const car=document.getElementById('pedidoCaracteristicasDiseno').value.trim();
      const notas=document.getElementById('pedidoNotas').value.trim();
      const total=(prod.precio||0)*cant + bord*(prod.precioBordadoExtra||0)
            + opts.reduce((s,n)=>s + ((prod.opcionesDiseno||[]).find(o=>o.nombre===n)?.precio||0)*cant,0);
      const data={
        clienteId:cliId, productoId:prodId, cantidad:cant,
        bordadosExtra:bord, incluyeDiseno:opts.length?'S√≠':'No',
        opcionesDisenoPedido:opts, caracteristicasDiseno:car, notas,
        total, estado:'En producci√≥n',
        fechaProduccion:new Date().toISOString().slice(0,10),
        fechaEntrega:'', clienteName:document.getElementById('pedidoClienteBuscador').value,
        productoDesc:document.getElementById('pedidoProductoBuscador').value
      };
      await db.collection('pedidos').add(data);
      // WA producci√≥n
      const cli=clientes.find(c=>c.id===cliId);
      if(cli?.telefono){
        const phone=cli.telefono.replace(/\D/g,'');
        const msg=`¬°Hola ${cli.nombre}! Tu pedido "${data.productoDesc}" ha sido enviado a producci√≥n.`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
      }
      resetForm('formPedido');
    });

    function setupPedidoFilters(){
      document.querySelectorAll('.pedido-filters .btn-filter').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelector('.pedido-filters .btn-filter.active').classList.remove('active');
          btn.classList.add('active');
          currentFilter=btn.dataset.filter;
          renderPedidos();
        });
      });
    }

    function renderPedidos(){
      const tbody=document.querySelector('#tablaPedidos tbody'); tbody.innerHTML='';
      const hoy=new Date().toISOString().slice(0,10);
      let lista=[];
      switch(currentFilter){
        case 'produccion': lista=pedidos.filter(d=>d.estado==='En producci√≥n'); break;
        case 'listos':     lista=pedidos.filter(d=>d.estado==='Listo para entrega'); break;
        case 'entregados': lista=pedidos.filter(d=>d.estado==='Entregado'); break;
        default:           lista=pedidos;
      }
      lista.forEach(d=>{
        const tr=document.createElement('tr');
        let btns='';
        if(d.estado==='En producci√≥n'){
          btns=`<button class="btn-secondary" onclick="marcarListo('${d.id}')">Marcar listo</button>`;
        } else if(d.estado==='Listo para entrega'){
          btns=`<button class="btn-secondary" onclick="confirmarEntrega('${d.id}')">Confirmar entrega</button>`;
        } else {
          btns='‚úÖ';
        }
        tr.innerHTML=`
          <td>${d.clienteName||''}</td>
          <td>${d.productoDesc||''}</td>
          <td>${d.cantidad}</td>
          <td>$${d.total.toFixed(2)}</td>
          <td>${d.estado}</td>
          <td>${d.fechaEntrega||''}</td>
          <td>${btns}</td>`;
        tbody.appendChild(tr);
      });
      pendingListos=pedidos.filter(d=>d.estado==='Listo para entrega');
      debouncedCalcRoute();
    }
    const debouncedCalcRoute=debounce(calcularRuta,500);

    async function marcarListo(id){
      const hoy=new Date().toISOString().slice(0,10);
      await db.collection('pedidos').doc(id).update({ estado:'Listo para entrega', fechaEntrega:hoy });
      const ped=pedidos.find(p=>p.id===id), cli=clientes.find(c=>c.id===ped.clienteId);
      if(cli?.telefono){
        const phone=cli.telefono.replace(/\D/g,'');
        const msg=`¬°Hola ${cli.nombre}! Tu pedido "${ped.productoDesc}" est√° listo para entrega el ${hoy}.`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
      }
    }
    async function confirmarEntrega(id){
      await db.collection('pedidos').doc(id).update({ estado:'Entregado' });
      const ped=pedidos.find(p=>p.id===id), cli=clientes.find(c=>c.id===ped.clienteId);
      if(cli?.telefono){
        const phone=cli.telefono.replace(/\D/g,'');
        const msg=`¬°Hola ${cli.nombre}! Tu pedido "${ped.productoDesc}" ha sido entregado. ¬°Gracias!`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
      }
    }

    // Mapas y rutas
    function initMapClientes(){
      if(mapClientesInit)return;
      mapClientes=L.map('mapClientes').setView([20,-100],5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(mapClientes);
      markersClientes=L.layerGroup().addTo(mapClientes);
      mapClientesInit=true; updateClientMarkers();
    }
    function updateClientMarkers(){
      markersClientes.clearLayers();
      clientes.forEach(c=>L.marker([c.latitud,c.longitud])
        .bindPopup(`<b>${c.nombre}</b><br>${c.empresa||''}`)
        .addTo(markersClientes));
    }
    function initMapRuta(){
      if(mapRutaInit)return;
      mapRuta=L.map('mapRuta').setView([20,-100],5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(mapRuta);
      mapRutaInit=true;
    }
    function calcularRuta(){
      if(!mapRutaInit) initMapRuta();
      if(routingControl) mapRuta.removeControl(routingControl);
      if(!pendingListos.length) return;
      const generar=origin=>{
        const destinos=pendingListos.map(p=>{
          const c=clientes.find(x=>x.id===p.clienteId);
          return L.latLng(c.latitud,c.longitud);
        });
        const waypoints=origin?[origin,...destinos]:destinos;
        routingControl=L.Routing.control({
          waypoints, routeWhileDragging:false, fitSelectedRoutes:true,
          showAlternatives:false,
          lineOptions:{ styles:[{ color:'blue',opacity:0.6,weight:4 }] },
          router:L.Routing.osrmv1({ serviceUrl:'https://router.project-osrm.org/route/v1' }),
          optimizeWaypoints:true
        }).addTo(mapRuta);
      };
      navigator.geolocation
        ? navigator.geolocation.getCurrentPosition(pos=>generar(L.latLng(pos.coords.latitude,pos.coords.longitude)), ()=>generar(null))
        : generar(null);
    }

    // Reportes
    function actualizarReportes(){
      document.getElementById('sumProduccion').textContent=
        `En producci√≥n: ${pedidos.filter(p=>p.estado==='En producci√≥n').length}`;
      document.getElementById('sumListos').textContent=
        `Listos para entrega: ${pedidos.filter(p=>p.estado==='Listo para entrega').length}`;
      document.getElementById('sumEntregados').textContent=
        `Entregados: ${pedidos.filter(p=>p.estado==='Entregado').length}`;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ubicaci√≥n con HERE Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: Arial; background: #f0f0f0; }
    #map { height: 300px; width: 100%; position: relative; }
    .center-marker {
      position: absolute; top: 50%; left: 50%;
      width: 32px; height: 32px;
      margin-top: -32px; margin-left: -16px;
      background: url('https://cdn-icons-png.flaticon.com/512/684/684908.png') no-repeat center center;
      background-size: 100%;
      z-index: 10; pointer-events: none;
    }
    .container {
      max-width: 480px; margin: 10px auto;
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%; padding: 12px; margin-bottom: 10px;
      border-radius: 6px; border: 1px solid #ccc; font-size: 16px;
    }
    button {
      background-color: #007bff; color: white; border: none;
      font-weight: bold; cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    #status { font-size: 14px; color: gray; margin: 10px 0; }
    ul#suggestions {
      list-style: none; padding: 0; margin-top: -10px;
      background: white; border: 1px solid #ccc;
      max-height: 150px; overflow-y: auto; position: absolute;
      width: 100%; z-index: 999;
    }
    ul#suggestions li {
      padding: 10px; cursor: pointer;
    }
    ul#suggestions li:hover {
      background: #f0f0f0;
    }
    #editarBtn {
      background-color: #6c757d;
    }
    .tipo-selector {
      display: flex; gap: 10px; margin: 10px 0;
    }
    .tipo-selector button {
      flex: 1; background: #e9ecef; color: #000;
      border: 1px solid #ccc;
    }
    .tipo-selector button.selected {
      background: #007bff; color: #fff; border-color: #0056b3;
    }
  </style>

  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
</head>
<body>

<div id="map">
  <div class="center-marker"></div>
</div>

<div class="container">
  <h3>Actualizar Direcci√≥n</h3>

  <div style="position:relative;">
    <input id="searchInput" type="text" placeholder="Buscar direcci√≥n..." autocomplete="off">
    <ul id="suggestions"></ul>
  </div>

  <button onclick="usarUbicacion()">üìç Usar mi ubicaci√≥n actual</button>
  <div id="status">Mueve el mapa o busca una direcci√≥n</div>

  <div class="tipo-selector">
    <button id="btnCasa" onclick="seleccionarTipo('Casa')">üè† Casa</button>
    <button id="btnTrabajo" onclick="seleccionarTipo('Trabajo')">üíº Trabajo</button>
    <button id="btnOtro" onclick="seleccionarTipo('Otro')">üìç Punto</button>
  </div>

  <form id="direccionForm">
    <label for="direccion">Direcci√≥n</label>
    <input type="text" id="direccion" readonly required>
    <input type="hidden" id="lat">
    <input type="hidden" id="lng">
    <input type="hidden" id="tipo">
    <button type="submit">Guardar Direcci√≥n</button>
  </form>

  <button id="editarBtn" onclick="permitirEditar()" style="display:none;">‚úèÔ∏è Editar direcci√≥n</button>
</div>

<script>
  const apiKey = 'CGKVKtMsXUqQO2Mt8Fw6N2Zxjiq6eTeFF3uSfaUum04';
  const platform = new H.service.Platform({ apikey: apiKey });
  const defaultLayers = platform.createDefaultLayers();
  let direccionFijada = false;

  const map = new H.Map(document.getElementById('map'), defaultLayers.vector.normal.map, {
    zoom: 15,
    center: { lat: 17.0732, lng: -96.7266 },
    pixelRatio: window.devicePixelRatio || 1
  });

  window.addEventListener('resize', () => map.getViewPort().resize());

  const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
  const ui = H.ui.UI.createDefault(map, defaultLayers);

  behavior.disable(H.mapevents.Behavior.WHEELZOOM);

  map.getElement().addEventListener('wheel', e => {
    if (direccionFijada) return;
    e.preventDefault();
    const zoom = map.getZoom();
    const delta = Math.sign(e.deltaY) > 0 ? -1 : 1;
    map.setZoom(zoom + delta);
  });

  let reverseGeocodeTimeout;
  map.addEventListener('mapviewchangeend', () => {
    if (!direccionFijada) actualizarDireccionDesdeCentro();
  });

  function actualizarUI(direccion, lat, lng, mensaje = '') {
    document.getElementById('direccion').value = direccion;
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
    document.getElementById('status').textContent = mensaje;
  }

  function actualizarDireccionDesdeCentro() {
    if (direccionFijada) return;

    clearTimeout(reverseGeocodeTimeout);
    reverseGeocodeTimeout = setTimeout(() => {
      const center = map.getCenter();
      fetch(`https://revgeocode.search.hereapi.com/v1/revgeocode?at=${center.lat},${center.lng}&lang=es&apikey=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          const direccion = data.items[0]?.address?.label || '';
          actualizarUI(direccion, center.lat, center.lng, 'Direcci√≥n actualizada autom√°ticamente.');
        });
    }, 300);
  }

  function usarUbicacion() {
    if (direccionFijada) return;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const nueva = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        map.setCenter(nueva);
        actualizarDireccionDesdeCentro();
      });
    }
  }

  function debounce(func, delay) {
    let timer;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  document.getElementById('searchInput').addEventListener('input', debounce(handleSearchInput, 300));

  function handleSearchInput(e) {
    if (direccionFijada) return;
    const query = e.target.value;
    if (query.length < 3) return;

    fetch(`https://autocomplete.search.hereapi.com/v1/autocomplete?q=${encodeURIComponent(query)}&at=17.0732,-96.7266&lang=es&limit=5&apikey=${apiKey}`)
      .then(res => res.json())
      .then(data => {
        const ul = document.getElementById('suggestions');
        ul.innerHTML = '';
        data.items?.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.address.label;
          li.onclick = () => {
            document.getElementById('searchInput').value = item.address.label;
            ul.innerHTML = '';
            fetch(`https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(item.address.label)}&lang=es&apikey=${apiKey}`)
              .then(res => res.json())
              .then(geo => {
                const pos = geo.items[0]?.position;
                if (pos) {
                  map.setCenter(pos);
                  actualizarDireccionDesdeCentro();
                } else {
                  alert('No se pudo ubicar la direcci√≥n con precisi√≥n.');
                }
              });
          };
          ul.appendChild(li);
        });
      });
  }

  function seleccionarTipo(tipo) {
    document.getElementById('tipo').value = tipo;
    ['btnCasa', 'btnTrabajo', 'btnOtro'].forEach(id => document.getElementById(id).classList.remove('selected'));
    document.getElementById(`btn${tipo}`).classList.add('selected');
  }

  document.getElementById('direccionForm').addEventListener('submit', e => {
    e.preventDefault();
    const tipo = document.getElementById('tipo').value;
    if (!tipo) return alert('Selecciona un tipo de direcci√≥n.');

    direccionFijada = true;
    document.getElementById('status').textContent = '‚úÖ Direcci√≥n fijada correctamente.';
    document.getElementById('editarBtn').style.display = 'block';
    alert('Direcci√≥n guardada correctamente.');
  });

  function permitirEditar() {
    direccionFijada = false;
    document.getElementById('status').textContent = 'Puedes mover el mapa o buscar una nueva direcci√≥n.';
    document.getElementById('editarBtn').style.display = 'none';
  }

  actualizarDireccionDesdeCentro();
</script>

</body>
</html>
